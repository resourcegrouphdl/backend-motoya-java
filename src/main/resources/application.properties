spring.application.name=backendMotoya
server.port=8080

spring.profiles.active=dev
logging.level.root=INFO
app.env=DEV

# Jackson
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.default-property-inclusion=non_null

# Firebase
firebase.project-id=motoya-form

# Firestore (Spring Cloud GCP)
spring.cloud.gcp.firestore.project-id=motoya-form

# SpringDoc / Swagger
springdoc.api-docs.path=/api-docs
springdoc.swagger-ui.path=/swagger-ui.html

# Thymeleaf
spring.thymeleaf.check-template-location=true
spring.thymeleaf.prefix=classpath:/templates/
spring.thymeleaf.suffix=.html
spring.thymeleaf.mode=HTML

# GCS - Firebase Storage bucket (motoya-form.appspot.com)
app.gcs.bucket-name=motoya-form.appspot.com

# Twilio (valores reales via env vars en prod / application-dev.properties en local)
twilio.account-sid=${TWILIO_ACCOUNT_SID}
twilio.auth-token=${TWILIO_AUTH_TOKEN}
twilio.whatsapp-from=${TWILIO_WHATSAPP_FROM:whatsapp:+14155238886}
# Deshabilitar validación de firma solo en tests, NUNCA en prod
twilio.validation.enabled=${TWILIO_VALIDATION_ENABLED:true}

# Google Calendar (módulo cobranza existente)
app.calendar.id=${CALENDAR_ID:primary}

# ─────────────────────────────────────────────────────────────────────────────
# Google Calendar - Módulo PROVISIONAL (eliminar junto con calendar/ package)
# ─────────────────────────────────────────────────────────────────────────────
# Cómo obtener estos valores:
#   1. Ve a Google Cloud Console → IAM → Cuentas de servicio
#   2. Crea/selecciona una SA con permiso "Editor de Google Calendar"
#   3. Descarga la clave JSON y copia los campos correspondientes
#   4. En application-dev.properties coloca los valores reales
#      (nunca commitear la private-key en el repositorio)
#
# Nota sobre private-key:
#   En .properties, los saltos de línea de la clave se escriben como \n
#   Ejemplo: -----BEGIN RSA PRIVATE KEY-----\nMIIE...\n-----END RSA PRIVATE KEY-----\n
#   También se puede usar la variable de entorno GOOGLE_CALENDAR_PRIVATE_KEY
# ─────────────────────────────────────────────────────────────────────────────
google.calendar.project-id=${GOOGLE_CALENDAR_PROJECT_ID:motoya-form}
google.calendar.client-email=${GOOGLE_CALENDAR_CLIENT_EMAIL:}
google.calendar.client-id=${GOOGLE_CALENDAR_CLIENT_ID:}
google.calendar.private-key-id=${GOOGLE_CALENDAR_PRIVATE_KEY_ID:}
google.calendar.private-key=${GOOGLE_CALENDAR_PRIVATE_KEY:}
google.calendar.calendar-id=${GOOGLE_CALENDAR_CALENDAR_ID:primary}

# =============================================================================
# RESILIENCIA — Resilience4j
# =============================================================================

# --- Circuit Breaker ----------------------------------------------------------
# twilio: WA/SMS — externa, tolera 50% fallos, espera 30s antes de reintentar
resilience4j.circuitbreaker.instances.twilio.sliding-window-size=10
resilience4j.circuitbreaker.instances.twilio.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.twilio.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.twilio.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.twilio.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.twilio.automatic-transition-from-open-to-half-open-enabled=true

# sunat: OSE fiscal — más permisivo (60%) pero espera 60s (evitar bloqueos tributarios)
resilience4j.circuitbreaker.instances.sunat.sliding-window-size=10
resilience4j.circuitbreaker.instances.sunat.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.sunat.failure-rate-threshold=60
resilience4j.circuitbreaker.instances.sunat.wait-duration-in-open-state=60s
resilience4j.circuitbreaker.instances.sunat.permitted-number-of-calls-in-half-open-state=2
resilience4j.circuitbreaker.instances.sunat.automatic-transition-from-open-to-half-open-enabled=true

# documentAi: OCR/extracción — 50% fallos, 30s espera, mínimo 3 llamadas
resilience4j.circuitbreaker.instances.documentAi.sliding-window-size=10
resilience4j.circuitbreaker.instances.documentAi.minimum-number-of-calls=3
resilience4j.circuitbreaker.instances.documentAi.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.documentAi.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.documentAi.permitted-number-of-calls-in-half-open-state=2
resilience4j.circuitbreaker.instances.documentAi.automatic-transition-from-open-to-half-open-enabled=true

# --- Retry --------------------------------------------------------------------
# firestoreTimeout: reintentos con backoff para timeouts gRPC de Firestore
resilience4j.retry.instances.firestoreTimeout.max-attempts=3
resilience4j.retry.instances.firestoreTimeout.wait-duration=500ms
resilience4j.retry.instances.firestoreTimeout.enable-exponential-backoff=true
resilience4j.retry.instances.firestoreTimeout.exponential-backoff-multiplier=2
resilience4j.retry.instances.firestoreTimeout.retry-exceptions=io.grpc.StatusRuntimeException,java.util.concurrent.TimeoutException

# sunatCdr: polling de CDR — hasta 5 intentos con backoff agresivo (2s → 4s → 8s…)
resilience4j.retry.instances.sunatCdr.max-attempts=5
resilience4j.retry.instances.sunatCdr.wait-duration=2s
resilience4j.retry.instances.sunatCdr.enable-exponential-backoff=true
resilience4j.retry.instances.sunatCdr.exponential-backoff-multiplier=2
resilience4j.retry.instances.sunatCdr.retry-exceptions=java.io.IOException,java.util.concurrent.TimeoutException

# --- Bulkhead (semáforo, compatible con Reactor/WebFlux) ----------------------
# twilio: máx 10 llamadas concurrentes — falla rápido si supera el límite
resilience4j.bulkhead.instances.twilio.max-concurrent-calls=10
resilience4j.bulkhead.instances.twilio.max-wait-duration=0ms

# sunat: máx 5 concurrentes — SUNAT OSE tiene rate-limit estricto
resilience4j.bulkhead.instances.sunat.max-concurrent-calls=5
resilience4j.bulkhead.instances.sunat.max-wait-duration=0ms

# documentAi: máx 3 concurrentes — Document AI es costoso y lento
resilience4j.bulkhead.instances.documentAi.max-concurrent-calls=3
resilience4j.bulkhead.instances.documentAi.max-wait-duration=0ms

# --- TimeLimiter --------------------------------------------------------------
# sunat: 30s (procesamiento XML + firma digital OSE)
resilience4j.timelimiter.instances.sunat.timeout-duration=30s
resilience4j.timelimiter.instances.sunat.cancel-running-future=true

# documentAi: 15s (inference del modelo)
resilience4j.timelimiter.instances.documentAi.timeout-duration=15s
resilience4j.timelimiter.instances.documentAi.cancel-running-future=true

# twilio: 10s (llamada HTTP a API REST)
resilience4j.timelimiter.instances.twilio.timeout-duration=10s
resilience4j.timelimiter.instances.twilio.cancel-running-future=true

# --- Actuator: exponer métricas y health de Resilience4j ---------------------
management.endpoints.web.exposure.include=health,info,metrics,circuitbreakers,retries,bulkheads
management.endpoint.health.show-details=when-authorized
management.health.circuitbreakers.enabled=true
management.health.retryevents.enabled=true
